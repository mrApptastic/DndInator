@using DndShared.Models

<div class="alert alert-info mb-4">
    <i class="bi bi-info-circle me-2"></i>
    Spells available are filtered based on your selected classes.
</div>

<CharacterSelectionListComponent 
        @ref="spellsComponent"
        TItem="Spell"
        AvailableItems="FilteredAvailableSpells"
        SelectedItems="SelectedSpells"
        SelectedItemsChanged="HandleSpellsSelected"
        GetDisplayName="@(s => $"{s.Name} ({GetSpellLevel(s)})")"
        ItemMetadataDisplay="@(s => s.School ?? string.Empty)"
        ItemTypeName="Spells"
        ItemsPerPage="15" />

@code {
    [Parameter]
    public List<CharacterClassLevel>? Classes { get; set; }

    [Parameter]
    public List<Spell> AvailableSpells { get; set; } = new();

    [Parameter]
    public List<Spell> SelectedSpells { get; set; } = new();

    [Parameter]
    public EventCallback<List<Spell>> OnSpellsChanged { get; set; }

    [Parameter]
    public EventCallback<bool> OnValidationChanged { get; set; }

    private CharacterSelectionListComponent<Spell>? spellsComponent;

    public bool IsValid => true; // Spells are always optional

    private List<Spell> FilteredAvailableSpells
    {
        get
        {
            if ((Classes?.Count ?? 0) == 0)
                return AvailableSpells;

            // Get union of class names from all selected classes
            var classNames = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
            foreach (var classLevel in Classes ?? new List<CharacterClassLevel>())
            {
                if (!string.IsNullOrWhiteSpace(classLevel.Class?.Name))
                {
                    classNames.Add(classLevel.Class.Name);
                }
            }

            if (!classNames.Any())
                return AvailableSpells;

            // Filter spells to those available for selected classes
            return AvailableSpells
                .Where(s => s.SpellLists?.Any(list => classNames.Contains(list)) ?? false)
                .ToList();
        }
    }

    private string GetSpellLevel(Spell spell)
    {
        return spell.Level == 0 ? "Cantrip" : $"Level {spell.Level}";
    }

    private async Task HandleSpellsSelected(List<Spell> spells)
    {
        SelectedSpells = spells;
        await OnSpellsChanged.InvokeAsync(spells);
        await OnValidationChanged.InvokeAsync(IsValid);
    }

    protected override async Task OnInitializedAsync()
    {
        await OnValidationChanged.InvokeAsync(IsValid);
    }
}

