@page "/charactersheet"
@using DndInator.Services
@using DndShared.Models
@using DndInator.Components
@using DndInator.Components.Steps
@inject ICharacterSheetService CharacterSheetService

<PageTitle>Character Sheet Generator</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-4 text-primary mb-3">
                <i class="bi bi-file-earmark-pdf-fill me-2"></i>
                Character Sheet Generator
            </h1>
            <p class="lead text-muted">Create your D&D 5e character step by step</p>
        </div>
    </div>

    <!-- Step Progress Indicator -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="progress" style="height: 30px;">
                <div class="progress-bar @GetProgressBarClass()" 
                     role="progressbar" 
                     style="width: @GetProgressPercentage()%"
                     aria-valuenow="@currentStep" 
                     aria-valuemin="0" 
                     aria-valuemax="@totalSteps">
                    Step @(currentStep + 1) of @totalSteps
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <!-- Step Content -->
            @if (currentStep == 0)
            {
                <CharacterInformationStep 
                    Information="character.Information"
                    OnInformationChanged="HandleInformationChanged"
                    OnValidationChanged="HandleStepValidation" />
            }
            else if (currentStep == 1)
            {
                <CharacterSpeciesStep 
                    Species="character.Race"
                    OnSpeciesChanged="HandleSpeciesChanged"
                    OnValidationChanged="HandleStepValidation" />
            }
            else if (currentStep == 2)
            {
                <CharacterClassStep 
                    Classes="character.Classes"
                    OnClassesChanged="HandleClassesChanged"
                    OnValidationChanged="HandleStepValidation" />
            }
            else if (currentStep == 3)
            {
                <CharacterBackgroundStep 
                    Background="character.Background"
                    OnBackgroundChanged="HandleBackgroundChanged"
                    OnValidationChanged="HandleStepValidation" />
            }
            else if (currentStep == 4)
            {
                <CharacterStatsStep 
                    Stats="character.Stats"
                    OnStatsChanged="HandleStatsChanged"
                    OnValidationChanged="HandleStepValidation" />
            }

            <!-- Step Navigation -->
            <div class="card shadow-sm mt-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <button class="btn btn-secondary" 
                                @onclick="PreviousStep"
                                disabled="@(currentStep == 0)">
                            <i class="bi bi-arrow-left me-2"></i>
                            Previous
                        </button>

                        @if (currentStep < totalSteps - 1)
                        {
                            <button class="btn btn-primary" 
                                    @onclick="NextStep"
                                    disabled="@(!isCurrentStepValid)">
                                Next
                                <i class="bi bi-arrow-right ms-2"></i>
                            </button>
                        }
                        else
                        {
                            <button class="btn btn-success" 
                                    @onclick="CompleteCharacterCreation"
                                    disabled="@(!isCurrentStepValid)">
                                <i class="bi bi-check-circle me-2"></i>
                                Complete
                            </button>
                        }
                    </div>
                </div>
            </div>

            <!-- Character Preview Card -->
            @if (characterCompleted)
            {
                <div class="card shadow-sm mt-3">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-person-badge me-2"></i>
                            Character Preview
                        </h5>
                    </div>
                    <div class="card-body">
                        <CharacterSheetDisplay Character="character" />
                        <CharacterSheetDisplay Character="character" />
                        
                        <button class="btn btn-primary btn-lg w-100 mt-3" 
                                @onclick="GenerateCharacterSheet" 
                                disabled="@isGenerating">
                            @if (isGenerating)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                <span>Generating...</span>
                            }
                            else
                            {
                                <i class="bi bi-file-earmark-pdf-fill me-2"></i>
                                <span>Generate PDF</span>
                            }
                        </button>

                        @if (!string.IsNullOrEmpty(pdfDataUrl))
                        {
                            <button class="btn btn-success btn-lg w-100 mt-2" 
                                    @onclick="DownloadCharacterSheet">
                                <i class="bi bi-download me-2"></i>
                                Download PDF
                            </button>
                        }

                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="alert alert-danger mt-3">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                @errorMessage
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(successMessage))
                        {
                            <div class="alert alert-success mt-3">
                                <i class="bi bi-check-circle-fill me-2"></i>
                                @successMessage
                            </div>
                        }
                    </div>
                </div>
            }
        </div>

        <div class="col-md-6">
            @if (!string.IsNullOrEmpty(pdfDataUrl))
            {
                <div class="card shadow-sm sticky-top" style="top: 20px;">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-eye-fill me-2"></i>
                            PDF Preview
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <iframe src="@pdfDataUrl" 
                                style="width: 100%; height: 800px; border: none;">
                        </iframe>
                    </div>
                </div>
            }
            else if (characterCompleted)
            {
                <div class="card shadow-sm sticky-top" style="top: 20px;">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-info-circle me-2"></i>
                            Character Summary
                        </h5>
                    </div>
                    <div class="card-body">
                        <h4 class="mb-3">@character.Information?.Name</h4>
                        
                        <div class="mb-3">
                            <strong>Species:</strong> @character.Race?.Name<br />
                            <strong>Class:</strong> @(character.Classes?.FirstOrDefault()?.Class?.Name ?? "â€”")<br />
                            <strong>Background:</strong> @character.Background?.Name<br />
                            <strong>Alignment:</strong> @GetAlignmentDisplayName(character.Information?.Alignment ?? CharacterAlignment.TrueNeutral)
                        </div>

                        <div class="mb-3">
                            <strong>Ability Scores:</strong>
                            <div class="row text-center mt-2">
                                <div class="col-4 mb-2">
                                    <div class="badge bg-primary w-100">STR: @character.Stats?.Strength</div>
                                </div>
                                <div class="col-4 mb-2">
                                    <div class="badge bg-primary w-100">DEX: @character.Stats?.Dexterity</div>
                                </div>
                                <div class="col-4 mb-2">
                                    <div class="badge bg-primary w-100">CON: @character.Stats?.Constitution</div>
                                </div>
                                <div class="col-4 mb-2">
                                    <div class="badge bg-primary w-100">INT: @character.Stats?.Intelligence</div>
                                </div>
                                <div class="col-4 mb-2">
                                    <div class="badge bg-primary w-100">WIS: @character.Stats?.Wisdom</div>
                                </div>
                                <div class="col-4 mb-2">
                                    <div class="badge bg-primary w-100">CHA: @character.Stats?.Charisma</div>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-success">
                            <i class="bi bi-check-circle me-2"></i>
                            Character creation complete! Generate PDF to download your character sheet.
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="card shadow-sm sticky-top" style="top: 20px;">
                    <div class="card-body text-center py-5">
                        <i class="bi bi-clipboard-check" style="font-size: 5rem; color: #ccc;"></i>
                        <p class="text-muted mt-3">Complete all steps to create your character</p>
                        <div class="mt-3">
                            <small class="text-muted">
                                Current Step: @GetStepName(currentStep)
                            </small>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<style>
    .hover-lift {
        transition: transform 0.2s;
    }
    .hover-lift:hover {
        transform: translateY(-2px);
    }
    .sticky-top {
        position: sticky;
    }
</style>

@code {
    private Character character = new Character();
    private string pdfDataUrl = string.Empty;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private bool isGenerating = false;
    
    // Step management
    private int currentStep = 0;
    private const int totalSteps = 5;
    private bool isCurrentStepValid = false;
    private bool characterCompleted = false;

    protected override void OnInitialized()
    {
        InitializeCharacter();
    }

    private void InitializeCharacter()
    {
        character = new Character
        {
            Information = new CharacterInformation
            {
                Alignment = CharacterAlignment.TrueNeutral
            },
            Stats = new CharacterStats
            {
                Strength = 10,
                Dexterity = 10,
                Constitution = 10,
                Intelligence = 10,
                Wisdom = 10,
                Charisma = 10
            }
        };
    }

    // Step navigation
    private void NextStep()
    {
        if (isCurrentStepValid && currentStep < totalSteps - 1)
        {
            currentStep++;
            isCurrentStepValid = false;
        }
    }

    private void PreviousStep()
    {
        if (currentStep > 0)
        {
            currentStep--;
            isCurrentStepValid = true; // Assume previously completed steps are valid
        }
    }

    private void CompleteCharacterCreation()
    {
        if (isCurrentStepValid)
        {
            characterCompleted = true;
            successMessage = "Character creation completed! You can now generate the PDF.";
            StateHasChanged();
        }
    }

    // Event handlers for step components
    private void HandleInformationChanged(CharacterInformation info)
    {
        character.Information = info;
    }

    private void HandleSpeciesChanged(DndShared.Models.Species species)
    {
        character.Race = species;
        if (character.Information != null)
        {
            character.Information.Race = species.Name;
        }
    }

    private void HandleClassesChanged(List<CharacterClassLevel> classes)
    {
        character.Classes = classes;
        if (character.Information != null && classes?.FirstOrDefault() != null)
        {
            character.Information.Class = classes.FirstOrDefault()!.Class?.Name;
        }
    }

    private void HandleBackgroundChanged(Background background)
    {
        character.Background = background;
        if (character.Information != null)
        {
            character.Information.Background = background.Name;
        }
    }

    private void HandleStatsChanged(CharacterStats stats)
    {
        character.Stats = stats;
    }

    private void HandleStepValidation(bool isValid)
    {
        isCurrentStepValid = isValid;
    }

    // Helper methods
    private string GetStepName(int step)
    {
        return step switch
        {
            0 => "Character Information",
            1 => "Species Selection",
            2 => "Class Selection",
            3 => "Background Selection",
            4 => "Ability Scores",
            _ => "Unknown"
        };
    }

    private double GetProgressPercentage()
    {
        return ((double)(currentStep + 1) / totalSteps) * 100;
    }

    private string GetProgressBarClass()
    {
        return currentStep == totalSteps - 1 && isCurrentStepValid 
            ? "bg-success" 
            : "bg-primary";
    }

    private string GetAlignmentDisplayName(CharacterAlignment alignment)
    {
        return alignment switch
        {
            CharacterAlignment.LawfulGood => "Lawful Good",
            CharacterAlignment.NeutralGood => "Neutral Good",
            CharacterAlignment.ChaoticGood => "Chaotic Good",
            CharacterAlignment.LawfulNeutral => "Lawful Neutral",
            CharacterAlignment.TrueNeutral => "True Neutral",
            CharacterAlignment.ChaoticNeutral => "Chaotic Neutral",
            CharacterAlignment.LawfulEvil => "Lawful Evil",
            CharacterAlignment.NeutralEvil => "Neutral Evil",
            CharacterAlignment.ChaoticEvil => "Chaotic Evil",
            _ => alignment.ToString()
        };
    }

    // PDF generation
    private async Task GenerateCharacterSheet()
    {
        isGenerating = true;
        errorMessage = string.Empty;
        successMessage = string.Empty;
        pdfDataUrl = string.Empty;
        StateHasChanged();

        try
        {
            pdfDataUrl = await CharacterSheetService.FillCharacterSheetAsync(character, "2024");
            successMessage = "Character sheet generated successfully!";
        }
        catch (Exception ex)
        {
            errorMessage = $"Error generating character sheet: {ex.Message}";
            Console.WriteLine($"Full error: {ex}");
        }
        finally
        {
            isGenerating = false;
            StateHasChanged();
        }
    }

    private async Task DownloadCharacterSheet()
    {
        try
        {
            await CharacterSheetService.DownloadCharacterSheetAsync(
                character, 
                $"{character.Information?.Name ?? "Character"}.pdf",
                "2024"
            );
            successMessage = "Download started!";
        }
        catch (Exception ex)
        {
            errorMessage = $"Error downloading: {ex.Message}";
        }
        StateHasChanged();
    }
}
