@page "/charactersheet"
@using DndInator.Services
@using DndShared.Models
@using DndInator.Components
@inject ICharacterSheetService CharacterSheetService

<PageTitle>Character Sheet Generator</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-4 text-primary mb-3">
                <i class="bi bi-file-earmark-pdf-fill me-2"></i>
                Character Sheet Generator
            </h1>
            <p class="lead text-muted">Generate a filled D&D 5e character sheet PDF</p>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <CharacterSheetDisplay Character="sampleCharacter" />
            
            <div class="card shadow-sm mt-3">
                <div class="card-body">
                    <button class="btn btn-primary btn-lg w-100" 
                            @onclick="GenerateCharacterSheet" 
                            disabled="@isGenerating">
                        @if (isGenerating)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            <span>Generating...</span>
                        }
                        else
                        {
                            <i class="bi bi-file-earmark-pdf-fill me-2"></i>
                            <span>Generate Character Sheet</span>
                        }
                    </button>

                    @if (!string.IsNullOrEmpty(pdfDataUrl))
                    {
                        <button class="btn btn-success btn-lg w-100 mt-2" 
                                @onclick="DownloadCharacterSheet">
                            <i class="bi bi-download me-2"></i>
                            Download PDF
                        </button>
                    }

                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger mt-3">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            @errorMessage
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(successMessage))
                    {
                        <div class="alert alert-success mt-3">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            @successMessage
                        </div>
                    }
                </div>
            </div>

            <div class="card shadow-sm mt-3">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        Debug Tools
                    </h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-outline-info w-100" 
                            @onclick="GetFormFields"
                            disabled="@isLoadingFields">
                        @if (isLoadingFields)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            <span>Loading...</span>
                        }
                        else
                        {
                            <i class="bi bi-list-ul me-2"></i>
                            <span>Get PDF Form Fields</span>
                        }
                    </button>

                    @if (formFields.Any())
                    {
                        <div class="mt-3" style="max-height: 300px; overflow-y: auto;">
                            <small class="text-muted">Found @formFields.Count fields:</small>
                            <ul class="list-group list-group-flush mt-2">
                                @foreach (var field in formFields)
                                {
                                    <li class="list-group-item py-1 px-2">
                                        <small>
                                            <strong>@field.Name</strong>
                                            <span class="badge bg-secondary ms-2">@field.Type</span>
                                        </small>
                                    </li>
                                }
                            </ul>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-6">
            @if (!string.IsNullOrEmpty(pdfDataUrl))
            {
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-eye-fill me-2"></i>
                            Preview
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <iframe src="@pdfDataUrl" 
                                style="width: 100%; height: 800px; border: none;">
                        </iframe>
                    </div>
                </div>
            }
            else
            {
                <div class="card shadow-sm">
                    <div class="card-body text-center py-5">
                        <i class="bi bi-file-earmark-pdf" style="font-size: 5rem; color: #ccc;"></i>
                        <p class="text-muted mt-3">Generate a character sheet to see preview</p>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<style>
    .hover-lift {
        transition: transform 0.2s;
    }
    .hover-lift:hover {
        transform: translateY(-2px);
    }
</style>

@code {
    private Character sampleCharacter = new Character();
    private string pdfDataUrl = string.Empty;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private bool isGenerating = false;
    private bool isLoadingFields = false;
    private List<FormField> formFields = new List<FormField>();

    protected override void OnInitialized()
    {
        // Create a sample character for testing
        sampleCharacter = new Character
        {
            Information = new CharacterInformation
            {
                Name = "Thorin Stonehammer",
                Race = "Mountain Dwarf",
                Class = "Fighter",
                Background = "Soldier",
                Alignment = CharacterAlignment.LawfulGood
            },
            Stats = new CharacterStats
            {
                Strength = 16,
                Dexterity = 12,
                Constitution = 15,
                Intelligence = 10,
                Wisdom = 13,
                Charisma = 8
            },
            Class = new CharacterClass
            {
                Name = "Fighter",
                HitPointDie = "d10",
                PrimaryAbility = "Strength or Dexterity",
                SavingThrowProficiencies = "Strength, Constitution",
                SkillProficiencies = "Choose 2 from Acrobatics, Animal Handling, Athletics, History, Insight, Intimidation, Perception, Survival"
            },
            Background = new Background
            {
                Name = "Soldier",
                Description = "War has been your life for as long as you care to remember.",
                SkillProficiencies = new List<string> { "Athletics", "Intimidation" },
                ToolProficiency = "Gaming Set or Vehicle (land)",
                Equipment = "Insignia of rank, trophy, gaming set or deck of cards, common clothes, belt pouch with 10gp"
            }
        };
        
        // Set up the race separately to avoid compilation issues
        sampleCharacter.Race = new DndShared.Models.Species
        {
            Name = "Mountain Dwarf",
            Speed = "25 ft.",
            Size = "Medium",
            Traits = new List<string> 
            { 
                "Darkvision (60 ft.)",
                "Dwarven Resilience",
                "Dwarven Combat Training",
                "Stonecunning"
            }
        };
        
        // Set up feats
        sampleCharacter.Feats = new List<Feat>
        {
            new Feat
            {
                Name = "Tough",
                Description = "Your hit point maximum increases by an amount equal to twice your level."
            }
        };
    }

    private async Task GenerateCharacterSheet()
    {
        isGenerating = true;
        errorMessage = string.Empty;
        successMessage = string.Empty;
        pdfDataUrl = string.Empty;
        StateHasChanged();

        try
        {
            pdfDataUrl = await CharacterSheetService.FillCharacterSheetAsync(sampleCharacter, "2024");
            successMessage = "Character sheet generated successfully!";
        }
        catch (Exception ex)
        {
            errorMessage = $"Error generating character sheet: {ex.Message}";
            Console.WriteLine($"Full error: {ex}");
        }
        finally
        {
            isGenerating = false;
            StateHasChanged();
        }
    }

    private async Task DownloadCharacterSheet()
    {
        try
        {
            await CharacterSheetService.DownloadCharacterSheetAsync(
                sampleCharacter, 
                $"{sampleCharacter.Information?.Name ?? "Character"}.pdf",
                "2024"
            );
            successMessage = "Download started!";
        }
        catch (Exception ex)
        {
            errorMessage = $"Error downloading: {ex.Message}";
        }
        StateHasChanged();
    }

    private async Task GetFormFields()
    {
        isLoadingFields = true;
        errorMessage = string.Empty;
        StateHasChanged();

        try
        {
            formFields = await CharacterSheetService.GetFormFieldsAsync("2024");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error getting form fields: {ex.Message}";
        }
        finally
        {
            isLoadingFields = false;
            StateHasChanged();
        }
    }
}
