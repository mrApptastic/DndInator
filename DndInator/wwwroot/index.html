<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DndInator</title>
    <base href="./" />
    <link rel="manifest" href="manifest.json" />
    <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png" />
    <link rel="preload" id="webassembly" />
    <link rel="stylesheet" href="lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/app.css" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <link href="DndInator.styles.css" rel="stylesheet" />
    <script type="importmap"></script>
</head>

<body>
    <div id="app">
        <svg class="loading-progress">
            <circle r="40%" cx="50%" cy="50%" />
            <circle r="40%" cx="50%" cy="50%" />
        </svg>
        <div class="loading-progress-text"></div>
    </div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="." class="reload">Reload</a>
        <span class="dismiss">ðŸ—™</span>
    </div>
    
    <!-- Update notification toast -->
    <div id="update-toast" style="display: none; position: fixed; bottom: 20px; right: 20px; z-index: 9999;">
        <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-primary text-white">
                <i class="bi bi-arrow-repeat me-2"></i>
                <strong class="me-auto">Update Available</strong>
                <button type="button" class="btn-close btn-close-white" onclick="document.getElementById('update-toast').style.display='none'"></button>
            </div>
            <div class="toast-body">
                A new version is available!
                <div class="mt-2 pt-2 border-top">
                    <button type="button" class="btn btn-primary btn-sm w-100" onclick="location.reload()">
                        Update Now
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="_framework/blazor.webassembly#[.{fingerprint}].js"></script>
    <script>
        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(registration => {
                    console.log('Service Worker registered:', registration);
                    
                    // Check for updates every 60 seconds
                    setInterval(() => {
                        console.log('Checking for service worker updates...');
                        registration.update();
                    }, 60000);
                    
                    // Listen for updates when a new service worker is waiting
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('New service worker found');
                        
                        newWorker.addEventListener('statechange', () => {
                            console.log('Service worker state:', newWorker.state);
                            if (newWorker.state === 'activated') {
                                console.log('New service worker activated');
                            }
                        });
                    });
                    
                    // Listen for controller change (new service worker took control)
                    navigator.serviceWorker.addEventListener('controllerchange', () => {
                        console.log('Service worker controller changed - showing update notification');
                        const toast = document.getElementById('update-toast');
                        if (toast) {
                            toast.style.display = 'block';
                        }
                    });
                })
                .catch(error => {
                    console.error('Service Worker registration failed:', error);
                });
            
            // Listen for update messages from service worker
            navigator.serviceWorker.addEventListener('message', event => {
                console.log('Message from service worker:', event.data);
                if (event.data && event.data.type === 'UPDATE_AVAILABLE') {
                    console.log('Update available message received');
                    const toast = document.getElementById('update-toast');
                    if (toast) {
                        toast.style.display = 'block';
                    }
                }
            });
        }
    </script>
</body>

</html>
